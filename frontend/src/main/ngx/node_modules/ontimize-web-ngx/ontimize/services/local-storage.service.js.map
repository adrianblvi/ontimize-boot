{"version":3,"file":"local-storage.service.js","sourceRoot":"","sources":["../../../tmp/ontimize/services/local-storage.service.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { EventEmitter, Injector } from '@angular/core';\nimport { NavigationStart, Router } from '@angular/router';\nimport { AppConfig, Config } from '../config/app-config';\nimport { SessionInfo } from '../services';\nimport { ObservableWrapper } from '../util/async';\nimport { Util } from '../util/util';\nimport { LoginService } from './login.service';\n\nexport interface ILocalStorageComponent {\n  storeState?: boolean;\n  getDataToStore(): Object;\n  getComponentKey(): string;\n  getRouteKey?(): string;\n}\n\nexport class LocalStorageService {\n  static COMPONENTS_STORAGE_KEY: string = 'components';\n  static USERS_STORAGE_KEY: string = 'users';\n  static SESSION_STORAGE_KEY: string = 'session';\n\n  public onRouteChange: EventEmitter<any> = new EventEmitter();\n  public onSetLocalStorage: EventEmitter<any> = new EventEmitter();\n\n  private _config: Config;\n  private _router: Router;\n  private loginService: LoginService;\n\n  constructor(protected injector: Injector) {\n    this._config = this.injector.get(AppConfig).getConfiguration();\n    this._router = this.injector.get(Router);\n    this.loginService = this.injector.get(LoginService);\n\n    const self = this;\n    this._router.events.subscribe(event => {\n      if (event instanceof NavigationStart) {\n        ObservableWrapper.callEmit(self.onRouteChange, {});\n      }\n    });\n  }\n\n  getComponentStorage(comp: ILocalStorageComponent, routeKey: string = undefined): Object {\n    const componentKey = comp.getComponentKey();\n    let completeKey = componentKey;\n    if (routeKey) {\n      completeKey += '_' + routeKey;\n    }\n    return this.getAppComponentData(completeKey) || {};\n  }\n\n  updateComponentStorage(comp: ILocalStorageComponent, routeKey: string = undefined) {\n    const dataToStore = comp.getDataToStore();\n    const componentKey = comp.getComponentKey();\n    if (!Util.isDefined(componentKey)) {\n      return;\n    }\n    let completeKey = componentKey;\n    if (routeKey) {\n      completeKey += '_' + routeKey;\n    }\n    let storedObject = {};\n    for (let prop in dataToStore) {\n      if (dataToStore.hasOwnProperty(prop)) {\n        storedObject[prop] = dataToStore[prop];\n      }\n    }\n    this.updateAppComponentStorage(completeKey, storedObject);\n  }\n\n  private getAppComponentData(key: string): Object {\n    let componentData = undefined;\n    let storedComponents: Object = this.getSessionUserComponentsData() || {};\n    if (storedComponents[key]) {\n      let decoded = atob(storedComponents[key]);\n      try {\n        componentData = JSON.parse(decoded);\n      } catch (e) {\n        componentData = undefined;\n      }\n    }\n    return componentData;\n  }\n\n  updateAppComponentStorage(componentKey: string, componentData: Object) {\n    let componentDataB64: Object = undefined;\n    try {\n      componentDataB64 = btoa(JSON.stringify(componentData));\n    } catch (e) {\n      componentDataB64 = undefined;\n    }\n    this.storeComponentInSessionUser(componentKey, componentDataB64);\n  }\n\n  public getSessionUserComponentsData(): Object {\n    let storedComponentsByUser = {};\n    let appData = this.getStoredData();\n    let session: SessionInfo = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};\n    let users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};\n    storedComponentsByUser = (users[session.user] || {})[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};\n    return storedComponentsByUser;\n  }\n\n  public storeSessionUserComponentsData(componentsData: object) {\n    let appData = this.getStoredData();\n    let session: SessionInfo = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};\n    if (!Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY])) {\n      appData[LocalStorageService.USERS_STORAGE_KEY] = {};\n    }\n    let userData = appData[LocalStorageService.USERS_STORAGE_KEY][session.user] || {};\n    userData[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsData;\n    appData[LocalStorageService.USERS_STORAGE_KEY][session.user] = userData;\n    this.setLocalStorage(appData);\n  }\n\n  private storeComponentInSessionUser(componentKey, componentDataB64) {\n    let appData = this.getStoredData();\n    let session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {}; // uuid -> session\n    if (!Util.isDefined(session) || !Util.isDefined(session.user)) {\n      return;\n    }\n    let users = appData[LocalStorageService.USERS_STORAGE_KEY] || {}; // uuid -> users\n    const idUser = session.user || this.loginService.getSessionInfo().user;\n    let user = users[idUser] || {}; //uuid -> users-> user\n\n    let componentData = {};\n    if (users[idUser]) {\n      componentData = users[idUser][LocalStorageService.COMPONENTS_STORAGE_KEY];\n    }\n    componentData[componentKey] = componentDataB64 || {};\n\n    user[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentData;\n    users[idUser] = user;\n    appData[LocalStorageService.USERS_STORAGE_KEY] = users;\n\n    this.setLocalStorage(appData);\n  }\n\n  public getStoredData(): Object {\n    let appData = {};\n    let appStoredData = localStorage.getItem(this._config['uuid']);\n    if (appStoredData) {\n      try {\n        appData = JSON.parse(appStoredData);\n      } catch (e) {\n        appData = {};\n      }\n    }\n    return appData;\n  }\n\n  public setBackwardCompatibility() {\n    let appData = this.getStoredData();\n    let session = appData[LocalStorageService.SESSION_STORAGE_KEY];\n    if (!Util.isDefined(session) || !Util.isDefined(session.user)) {\n      return;\n    }\n    let componentsInfo = appData[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};\n    let usersObject = {};\n    const existsUsersTag = Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY]);\n    let createUserInfo = existsUsersTag;\n    if (existsUsersTag) {\n      usersObject = appData[LocalStorageService.USERS_STORAGE_KEY];\n      createUserInfo = !Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY][session.user]);\n    }\n    if (createUserInfo) {\n      usersObject[session.user] = {};\n      usersObject[session.user][LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsInfo;\n\n      appData[LocalStorageService.USERS_STORAGE_KEY] = usersObject;\n      localStorage.setItem(this._config['uuid'], JSON.stringify(appData));\n    }\n  }\n\n  protected setLocalStorage(appData: any) {\n    this.onSetLocalStorage.emit();\n    localStorage.setItem(this._config['uuid'], JSON.stringify(appData));\n  }\n}\n\n"]}