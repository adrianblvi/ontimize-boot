{"version":3,"file":"o-form.cache.class.js","sourceRoot":"","sources":["../../../../../tmp/ontimize/components/form/cache/o-form.cache.class.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,YAAY,EAAE,MAAM,eAAe,CAAC;AAC7C,OAAO,EAAE,IAAI,EAAE,MAAM,gBAAgB,CAAC;AAItC;IAcE,yBAAsB,IAAoB;QAApB,SAAI,GAAJ,IAAI,CAAgB;QAZhC,qBAAgB,GAAW,EAAE,CAAC;QAE9B,sBAAiB,GAAe,EAAE,CAAC;QACnC,6BAAwB,GAAQ,EAAE,CAAC;QACnC,iBAAY,GAAY,KAAK,CAAC;QAC9B,qBAAgB,GAAY,KAAK,CAAC;QAE5C,6BAAwB,GAA0B,IAAI,YAAY,EAAW,CAAC;QAC9E,wBAAmB,GAAsB,IAAI,YAAY,EAAO,CAAC;QAEvD,wBAAmB,GAAa,EAAE,CAAC;IAG7C,CAAC;IAES,6CAAmB,GAA7B;QACE,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,yBAAyB,EAAE,CAAC;IAC7D,CAAC;IAES,0CAAgB,GAA1B,UAA2B,IAA2B;QACpD,IAAM,YAAY,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC,KAAK,CAAC;QACjD,IAAM,QAAQ,GAAG,IAAI,CAAC,iBAAiB,CAAC,MAAM,KAAK,CAAC,CAAC;QACrD,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC;YAC1B,IAAI,EAAE,IAAI,CAAC,YAAY,EAAE;YACzB,KAAK,EAAE,YAAY;SACpB,CAAC,CAAC;QACH,IAAI,QAAQ,EAAE;YACZ,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;SAC3C;QACD,IAAI,CAAC,mBAAmB,CAAC,IAAI,EAAE,CAAC;IAClC,CAAC;IAES,kDAAwB,GAAlC,UAAmC,IAAwB;QACzD,IAAM,IAAI,GAAG,IAAI,CAAC;QAClB,IAAM,IAAI,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;QACjC,IAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC;QACpF,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,EAAE;YAC7B,OAAO;SACR;QACD,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,GAAG,QAAQ,CAAC,SAAS,CAAC;YACvD,IAAI,IAAI,CAAC,gBAAgB,IAAI,CAAC,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,mBAAmB,CAAC,IAAI,EAAE,IAAI,CAAC,EAAE;gBACvF,IAAI,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE;oBACjD,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;iBACrC;gBACD,IAAI,CAAC,mBAAmB,EAAE,CAAC;gBAC3B,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;aAC7B;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,wCAAc,GAAd,UAAe,IAAY;QACzB,IAAI,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE;YACjE,OAAO,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;SACjC;QACD,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,iCAAO,GAAP;QAAA,iBAQC;QAPC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,wBAAwB,CAAC,CAAC,OAAO,CAAC,UAAC,IAAI;YACtD,IAAM,IAAI,GAAiB,KAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,CAAC;YAC/D,IAAI,CAAC,WAAW,EAAE,CAAC;QACrB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,wBAAwB,GAAG,EAAE,CAAC;QACnC,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;QAC/B,IAAI,CAAC,mBAAmB,GAAG,EAAE,CAAC;IAChC,CAAC;IAES,mDAAyB,GAAnC,UAAoC,GAAQ;QAC1C,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,UAAC,GAAG;YAC3B,IAAI,GAAG,CAAC,GAAG,CAAC,KAAK,SAAS,EAAE;gBAC1B,OAAO,GAAG,CAAC,GAAG,CAAC,CAAC;aACjB;QACH,CAAC,CAAC,CAAC;QACH,OAAO,GAAG,CAAC;IACb,CAAC;IAED,uCAAa,GAAb;QACE,IAAI,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC,yBAAyB,EAAE,CAAC;QACzD,IAAI,CAAC,yBAAyB,CAAC,YAAY,CAAC,CAAC;QAC7C,IAAI,CAAC,eAAe,CAAC,YAAY,CAAC,CAAC;QACnC,IAAI,CAAC,aAAa,GAAG,YAAY,CAAC;QAElC,IAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;QAC7C,IAAM,IAAI,GAAG,IAAI,CAAC;QAClB,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,OAAO,CAAC,UAAA,IAAI;YAClC,IAAM,IAAI,GAAuB,UAAU,CAAC,IAAI,CAAC,CAAC;YAClD,IAAI,IAAI,CAAC,sBAAsB,EAAE,EAAE;gBACjC,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,CAAC;aACrC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,yCAAe,GAAf,UAAgB,GAAQ;QACtB,IAAI,CAAC,gBAAgB,GAAG,GAAG,CAAC;QAC5B,IAAI,CAAC,iBAAiB,GAAG,EAAE,CAAC;QAC5B,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACzC,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC;QAC7B,IAAI,CAAC,mBAAmB,GAAG,EAAE,CAAC;IAChC,CAAC;IAED,6CAAmB,GAAnB;QACE,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC/B,CAAC;IAED,sCAAY,GAAZ;QACE,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B,CAAC;IAED,sCAAY,GAAZ;QACE,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;QAC/B,IAAI,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC;QACzB,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAC;QAC9B,IAAI,CAAC,mBAAmB,CAAC,IAAI,EAAE,CAAC;IAClC,CAAC;IAED,0CAAgB,GAAhB;QACE,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC,CAAC;IAC5C,CAAC;IAED,wCAAc,GAAd,UAAe,OAAQ;QACrB,OAAO,GAAG,CAAC,OAAO,IAAI,EAAE,CAAC,CAAC;QAC1B,IAAI,WAAW,GAAG,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,iBAAiB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAC5E,IAAI,WAAW,EAAE;YACf,IAAM,cAAc,GAAG,IAAI,CAAC,iBAAiB,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;YAChE,IAAM,SAAS,GAAG,CAAC,cAAc,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;YACvG,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;YAErD,IAAI,CAAC,mBAAmB,EAAE,CAAC;YAC3B,IAAI,CAAC,mBAAmB,CAAC,IAAI,EAAE,CAAC;SACjC;IACH,CAAC;IAES,4CAAkB,GAA5B,UAA6B,IAAY,EAAE,GAAQ;QACjD,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC/C,IAAI,IAAI,EAAE;YAER,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;SACpB;QACD,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;IAC5B,CAAC;IAES,6CAAmB,GAA7B,UAA8B,IAAY,EAAE,IAA2B;QACrE,IAAM,YAAY,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC,KAAK,CAAC;QACjD,IAAM,KAAK,GAAG,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,gBAAgB,CAAC;QAC1D,OAAO,CAAC,YAAY,KAAK,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;IACxC,CAAC;IAES,2CAAiB,GAA3B,UAA4B,IAAY;QACtC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;QAC9B,IAAI,MAAM,GAAG,IAAI,CAAC;QAClB,KAAK,IAAI,CAAC,GAAG,IAAI,CAAC,iBAAiB,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;YAC3D,IAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;YAC1C,IAAI,OAAO,CAAC,IAAI,KAAK,IAAI,EAAE;gBACzB,MAAM,GAAG,OAAO,CAAC,KAAK,CAAC;gBACvB,MAAM;aACP;SACF;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAES,4CAAkB,GAA5B,UAA6B,IAAY;QACvC,IAAI,KAAK,GAAW,SAAS,CAAC;QAC9B,KAAK,IAAI,CAAC,GAAG,IAAI,CAAC,iBAAiB,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;YAC3D,IAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;YAC1C,IAAI,OAAO,CAAC,IAAI,KAAK,IAAI,EAAE;gBACzB,KAAK,GAAG,CAAC,CAAC;gBACV,MAAM;aACP;SACF;QACD,IAAI,KAAK,KAAK,SAAS,EAAE;YACvB,KAAK,IAAI,CAAC,GAAG,KAAK,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC/B,IAAM,IAAI,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;gBAC3C,IAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;gBAC1C,IAAI,OAAO,CAAC,IAAI,KAAK,IAAI,EAAE;oBACzB,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;oBACpC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,KAAK,IAAI,EAAE;wBAC/B,SAAS;qBACV;yBAAM;wBACL,MAAM;qBACP;iBACF;aACF;SACF;QACD,IAAI,IAAI,CAAC,iBAAiB,CAAC,MAAM,KAAK,CAAC,EAAE;YACvC,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SAC1C;IACH,CAAC;IAED,sBAAI,8CAAiB;aAArB;YACE,OAAO,CAAC,IAAI,CAAC,iBAAiB,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC;QAC/C,CAAC;;;OAAA;IAED,+CAAqB,GAArB;QACE,IAAI,YAAY,CAAC;QACjB,IAAI,IAAI,CAAC,aAAa,EAAE;YACtB,YAAY,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;YACrD,IAAI,CAAC,yBAAyB,CAAC,YAAY,CAAC,CAAC;SAC9C;QAED,IAAI,WAAW,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QACrD,IAAI,WAAW,GAAG,YAAY,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC;QACzE,IAAI,WAAW,CAAC,MAAM,KAAK,WAAW,CAAC,MAAM,EAAE;YAC7C,OAAO,IAAI,CAAC;SACb;QACD,IAAI,GAAG,GAAG,KAAK,CAAC;QAChB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,GAAG,WAAW,CAAC,MAAM,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,EAAE;YACtD,IAAI,GAAG,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;YAEzB,GAAG,GAAG,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC;YACzD,IAAI,GAAG,EAAE;gBACP,MAAM;aACP;SACF;QACD,OAAO,GAAG,CAAC;IACb,CAAC;IAED,oDAA0B,GAA1B;QACE,OAAO,IAAI,CAAC,mBAAmB,CAAC;IAClC,CAAC;IACH,sBAAC;AAAD,CAAC,AA9ND,IA8NC","sourcesContent":["\nimport { Subscription } from 'rxjs';\nimport { EventEmitter } from '@angular/core';\nimport { Util } from '../../../utils';\nimport { IFormControlComponent, IFormDataComponent } from '../../o-form-data-component.class';\nimport { OFormComponent } from '../o-form.component';\n\nexport class OFormCacheClass {\n\n  protected initialDataCache: Object = {};\n  protected formDataCache: Object;\n  protected valueChangesStack: Array<any> = [];\n  protected _componentsSubscritpions: any = {};\n  protected blockCaching: boolean = false;\n  protected initializedCache: boolean = false;\n\n  onCacheEmptyStateChanges: EventEmitter<boolean> = new EventEmitter<boolean>();\n  onCacheStateChanges: EventEmitter<any> = new EventEmitter<any>();\n\n  protected changedFormControls: string[] = [];\n\n  constructor(protected form: OFormComponent) {\n  }\n\n  protected updateFormDataCache() {\n    this.formDataCache = this.form.getRegisteredFieldsValues();\n  }\n\n  protected addChangeToStack(comp: IFormControlComponent) {\n    const currentValue = comp.getFormControl().value;\n    const wasEmpty = this.valueChangesStack.length === 0;\n    this.valueChangesStack.push({\n      attr: comp.getAttribute(),\n      value: currentValue\n    });\n    if (wasEmpty) {\n      this.onCacheEmptyStateChanges.emit(false);\n    }\n    this.onCacheStateChanges.emit();\n  }\n\n  protected registerComponentCaching(comp: IFormDataComponent) {\n    const self = this;\n    const attr = comp.getAttribute();\n    const listenTo = this.form.detectChangesOnBlur ? comp.onValueChange : comp.onChange;\n    if (!Util.isDefined(listenTo)) {\n      return;\n    }\n    this._componentsSubscritpions[attr] = listenTo.subscribe(() => {\n      if (self.initializedCache && !self.blockCaching && self.hasComponentChanged(attr, comp)) {\n        if (self.changedFormControls.indexOf(attr) === -1) {\n          self.changedFormControls.push(attr);\n        }\n        self.updateFormDataCache();\n        self.addChangeToStack(comp);\n      }\n    });\n  }\n\n  getCachedValue(attr: string): any {\n    if (this.formDataCache && this.formDataCache.hasOwnProperty(attr)) {\n      return this.formDataCache[attr];\n    }\n    return undefined;\n  }\n\n  destroy() {\n    Object.keys(this._componentsSubscritpions).forEach((attr) => {\n      const subs: Subscription = this._componentsSubscritpions[attr];\n      subs.unsubscribe();\n    });\n    this._componentsSubscritpions = {};\n    this.formDataCache = undefined;\n    this.changedFormControls = [];\n  }\n\n  protected removeUndefinedProperties(arg: any): any {\n    Object.keys(arg).forEach((key) => {\n      if (arg[key] === undefined) {\n        delete arg[key];\n      }\n    });\n    return arg;\n  }\n\n  registerCache() {\n    let initialCache = this.form.getRegisteredFieldsValues();\n    this.removeUndefinedProperties(initialCache);\n    this.initializeCache(initialCache);\n    this.formDataCache = initialCache;\n\n    const components = this.form.getComponents();\n    const self = this;\n    Object.keys(components).forEach(attr => {\n      const comp: IFormDataComponent = components[attr];\n      if (comp.isAutomaticRegistering()) {\n        self.registerComponentCaching(comp);\n      }\n    });\n  }\n\n  initializeCache(val: any) {\n    this.initialDataCache = val;\n    this.valueChangesStack = [];\n    this.onCacheEmptyStateChanges.emit(true);\n    this.initializedCache = true;\n    this.changedFormControls = [];\n  }\n\n  getInitialDataCache() {\n    return this.initialDataCache;\n  }\n\n  getDataCache() {\n    return this.formDataCache;\n  }\n\n  restartCache() {\n    this.formDataCache = undefined;\n    this.initializeCache({});\n    this.initializedCache = false;\n    this.onCacheStateChanges.emit();\n  }\n\n  setCacheSnapshot() {\n    this.initializeCache(this.getDataCache());\n  }\n\n  undoLastChange(options?) {\n    options = (options || {});\n    var lastElement = this.valueChangesStack[this.valueChangesStack.length - 1];\n    if (lastElement) {\n      const lastCacheValue = this.getCacheLastValue(lastElement.attr);\n      const lastValue = (lastCacheValue !== null) ? lastCacheValue : this.initialDataCache[lastElement.attr];\n      this.undoComponentValue(lastElement.attr, lastValue);\n\n      this.updateFormDataCache();\n      this.onCacheStateChanges.emit();\n    }\n  }\n\n  protected undoComponentValue(attr: string, val: any) {\n    this.blockCaching = true;\n    const comp = this.form.getFieldReference(attr);\n    if (comp) {\n      // (comp as any).oldValue = undefined;\n      comp.setValue(val);\n    }\n    this.blockCaching = false;\n  }\n\n  protected hasComponentChanged(attr: string, comp: IFormControlComponent): boolean {\n    const currentValue = comp.getFormControl().value;\n    const cache = this.formDataCache || this.initialDataCache;\n    return (currentValue !== cache[attr]);\n  }\n\n  protected getCacheLastValue(attr: string): any {\n    this.updateChangesStack(attr);\n    let result = null;\n    for (let i = this.valueChangesStack.length - 1; i >= 0; i--) {\n      const current = this.valueChangesStack[i];\n      if (current.attr === attr) {\n        result = current.value;\n        break;\n      }\n    }\n    return result;\n  }\n\n  protected updateChangesStack(attr: string) {\n    let index: number = undefined;\n    for (let i = this.valueChangesStack.length - 1; i >= 0; i--) {\n      const current = this.valueChangesStack[i];\n      if (current.attr === attr) {\n        index = i;\n        break;\n      }\n    }\n    if (index !== undefined) {\n      for (let i = index; i >= 0; i--) {\n        const prev = this.valueChangesStack[i - 1];\n        const current = this.valueChangesStack[i];\n        if (current.attr === attr) {\n          this.valueChangesStack.splice(i, 1);\n          if (!prev || prev.attr === attr) {\n            continue;\n          } else {\n            break;\n          }\n        }\n      }\n    }\n    if (this.valueChangesStack.length === 0) {\n      this.onCacheEmptyStateChanges.emit(true);\n    }\n  }\n\n  get isCacheStackEmpty(): boolean {\n    return (this.valueChangesStack.length === 0);\n  }\n\n  isInitialStateChanged(): boolean {\n    let currentCache;\n    if (this.formDataCache) {\n      currentCache = Object.assign({}, this.formDataCache);\n      this.removeUndefinedProperties(currentCache);\n    }\n\n    let initialKeys = Object.keys(this.initialDataCache);\n    let currentKeys = currentCache ? Object.keys(currentCache) : initialKeys;\n    if (initialKeys.length !== currentKeys.length) {\n      return true;\n    }\n    let res = false;\n    for (let i = 0, len = initialKeys.length; i < len; i++) {\n      let key = initialKeys[i];\n      // TODO be careful with types comparisions\n      res = (this.initialDataCache[key] !== currentCache[key]);\n      if (res) {\n        break;\n      }\n    }\n    return res;\n  }\n\n  getChangedFormControlsAttr(): string[] {\n    return this.changedFormControls;\n  }\n}\n"]}